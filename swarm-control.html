<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLOOMCRAWLER RIIS - Swarm Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
        }
        .glow {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        .worker-online { background: #10b981; }
        .worker-working { background: #3b82f6; }
        .worker-error { background: #ef4444; }
        .worker-idle { background: #6b7280; }
        .target-pending { border-left: 4px solid #f59e0b; }
        .target-crawling { border-left: 4px solid #3b82f6; }
        .target-completed { border-left: 4px solid #10b981; }
        .target-failed { border-left: 4px solid #ef4444; }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto p-6">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                Advanced Swarm Crawler
            </h1>
            <p class="text-xl text-gray-300 mb-6">Multi-threaded Distributed Crawling Engine</p>
            <div class="flex justify-center space-x-4 text-sm text-gray-400">
                <span>Status: <span id="swarm-status" class="text-red-400">STOPPED</span></span>
                <span>Workers: <span id="worker-count">0/0</span></span>
                <span>Queue: <span id="queue-size">0</span></span>
            </div>
        </div>

        <!-- Statistics Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-lg p-4 border border-gray-700 glow text-center">
                <div class="text-2xl font-bold text-blue-400" id="total-workers">0</div>
                <div class="text-sm text-gray-400">Total Workers</div>
            </div>
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-lg p-4 border border-gray-700 glow text-center">
                <div class="text-2xl font-bold text-green-400" id="active-workers">0</div>
                <div class="text-sm text-gray-400">Active Workers</div>
            </div>
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-lg p-4 border border-gray-700 glow text-center">
                <div class="text-2xl font-bold text-purple-400" id="items-found">0</div>
                <div class="text-sm text-gray-400">Items Found</div>
            </div>
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-lg p-4 border border-gray-700 glow text-center">
                <div class="text-2xl font-bold text-cyan-400" id="processing-speed">0.0</div>
                <div class="text-sm text-gray-400">Items/sec</div>
            </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-6">
            <!-- Target Configuration -->
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-lg p-6 border border-gray-700">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i data-lucide="target" class="w-6 h-6 mr-3 text-red-400"></i>
                    Target Configuration
                </h2>

                <div id="targets-list" class="space-y-3 mb-6">
                    <!-- Targets will be added here dynamically -->
                </div>

                <div class="flex space-x-3">
                    <button id="add-target" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>Add Target</span>
                    </button>
                    <button id="start-swarm" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors">
                        <i data-lucide="play" class="w-4 h-4"></i>
                        <span>Start Swarm</span>
                    </button>
                    <button id="stop-swarm" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors">
                        <i data-lucide="square" class="w-4 h-4"></i>
                        <span>Stop Swarm</span>
                    </button>
                </div>
            </div>

            <!-- Worker Status -->
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-lg p-6 border border-gray-700">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i data-lucide="cpu" class="w-6 h-6 mr-3 text-yellow-400"></i>
                    Worker Status
                </h2>

                <div id="workers-list" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="text-gray-400 text-center py-8">
                        <i data-lucide="loader" class="w-8 h-8 mx-auto mb-2 animate-spin text-blue-400"></i>
                        <p>No workers active</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="mt-6 bg-gray-800/50 backdrop-blur-sm rounded-lg p-6 border border-gray-700">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <i data-lucide="activity" class="w-6 h-6 mr-3 text-green-400"></i>
                Swarm Activity Log
            </h2>
            <div id="activity-log" class="space-y-3 max-h-64 overflow-y-auto">
                <div class="text-gray-400 text-center py-8">
                    <i data-lucide="loader" class="w-8 h-8 mx-auto mb-2 animate-spin text-blue-400"></i>
                    <p>Loading swarm activity...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api/swarm';
        let targets = [];
        let nextTargetId = 1;

        // Initialize Lucide icons
        lucide.createIcons();

        // Update status
        function updateSwarmStatus(status, workers, queue) {
            const statusElement = document.getElementById('swarm-status');
            const workerElement = document.getElementById('worker-count');
            const queueElement = document.getElementById('queue-size');

            statusElement.textContent = status.toUpperCase();
            statusElement.className = status === 'running' ? 'text-green-400' :
                                    status === 'stopped' ? 'text-red-400' : 'text-yellow-400';

            workerElement.textContent = `${workers.active || 0}/${workers.total || 0}`;
            queueElement.textContent = queue || 0;
        }

        // Add activity log entry
        function addActivityLog(message, type = 'info') {
            const log = document.getElementById('activity-log');
            const timestamp = new Date().toLocaleTimeString();

            const colors = {
                success: 'text-green-400',
                warning: 'text-yellow-400',
                error: 'text-red-400',
                info: 'text-blue-400'
            };

            const entry = document.createElement('div');
            entry.className = 'flex items-start space-x-3 p-3 bg-gray-700/30 rounded-lg';
            entry.innerHTML = `
                <div class="w-2 h-2 rounded-full bg-${type === 'success' ? 'green' : type === 'warning' ? 'yellow' : type === 'error' ? 'red' : 'blue'}-400 mt-2"></div>
                <div class="flex-1">
                    <div class="text-sm font-semibold ${colors[type]}">${message}</div>
                    <div class="text-xs text-gray-500">${timestamp}</div>
                </div>
            `;

            // Remove loading message if present
            const loadingMsg = log.querySelector('.text-gray-400');
            if (loadingMsg) {
                loadingMsg.remove();
            }

            log.insertBefore(entry, log.firstChild);

            // Keep only last 30 entries
            while (log.children.length > 30) {
                log.removeChild(log.lastChild);
            }
        }

        // Create target element
        function createTargetElement(target) {
            const element = document.createElement('div');
            element.className = `p-4 bg-gray-700/50 rounded-lg border-l-4 target-${target.status || 'pending'}`;
            element.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-3">
                        <span class="text-sm font-semibold text-gray-300">${target.url}</span>
                        <span class="px-2 py-1 text-xs rounded-full ${
                            target.type === 'tor' ? 'bg-purple-500/20 text-purple-400' :
                            target.type === 'i2p' ? 'bg-blue-500/20 text-blue-400' :
                            target.type === 'surface' ? 'bg-green-500/20 text-green-400' :
                            'bg-gray-500/20 text-gray-400'
                        }">${target.type.toUpperCase()}</span>
                    </div>
                    <button class="remove-target text-red-400 hover:text-red-300 p-1" data-id="${target.id}">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="flex items-center space-x-4 text-sm text-gray-400">
                    <span>Priority: ${target.priority}</span>
                    <span>Status: <span class="capitalize">${target.status || 'pending'}</span></span>
                </div>
            `;

            // Add remove event listener
            element.querySelector('.remove-target').addEventListener('click', (e) => {
                const targetId = parseInt(e.currentTarget.dataset.id);
                targets = targets.filter(t => t.id !== targetId);
                updateTargetsList();
                addActivityLog(`Target removed: ${target.url}`, 'warning');
            });

            return element;
        }

        // Update targets list
        function updateTargetsList() {
            const container = document.getElementById('targets-list');
            container.innerHTML = '';

            if (targets.length === 0) {
                container.innerHTML = `
                    <div class="text-gray-400 text-center py-8">
                        <i data-lucide="target" class="w-8 h-8 mx-auto mb-2 text-gray-500"></i>
                        <p>No targets configured</p>
                        <p class="text-sm">Click "Add Target" to get started</p>
                    </div>
                `;
            } else {
                targets.forEach(target => {
                    container.appendChild(createTargetElement(target));
                });
            }

            lucide.createIcons();
        }

        // Create worker element
        function createWorkerElement(worker) {
            const element = document.createElement('div');
            element.className = 'p-4 bg-gray-700/50 rounded-lg border border-gray-600';
            element.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-3">
                        <i data-lucide="cpu" class="w-5 h-5 text-blue-400"></i>
                        <span class="font-mono text-sm text-gray-300">${worker.id}</span>
                        <div class="w-3 h-3 rounded-full worker-${worker.status}"></div>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-full ${
                        worker.status === 'working' ? 'bg-blue-500/20 text-blue-400' :
                        worker.status === 'idle' ? 'bg-gray-500/20 text-gray-400' :
                        'bg-red-500/20 text-red-400'
                    }">${worker.status.toUpperCase()}</span>
                </div>
                ${worker.currentTarget ? `
                    <div class="text-sm text-gray-400 mb-2">
                        <div class="truncate">Crawling: ${worker.currentTarget.url}</div>
                    </div>
                ` : ''}
                <div class="text-xs text-gray-500">
                    Tasks completed: ${worker.tasksCompleted}
                </div>
            `;

            return element;
        }

        // Update workers list
        function updateWorkersList(workers) {
            const container = document.getElementById('workers-list');
            container.innerHTML = '';

            if (!workers || workers.length === 0) {
                container.innerHTML = `
                    <div class="text-gray-400 text-center py-8">
                        <i data-lucide="cpu" class="w-8 h-8 mx-auto mb-2 text-gray-500"></i>
                        <p>No workers active</p>
                    </div>
                `;
            } else {
                workers.forEach(worker => {
                    container.appendChild(createWorkerElement(worker));
                });
            }

            lucide.createIcons();
        }

        // Fetch swarm statistics
        async function fetchSwarmStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const data = await response.json();

                if (data.success) {
                    // Update statistics
                    document.getElementById('total-workers').textContent = data.data.totalWorkers || 0;
                    document.getElementById('active-workers').textContent = data.data.activeWorkers || 0;
                    document.getElementById('items-found').textContent = (data.data.itemsFound || 0).toLocaleString();
                    document.getElementById('processing-speed').textContent = (data.data.averageSpeed || 0).toFixed(1);

                    // Update status
                    const isRunning = data.data.activeWorkers > 0 || data.data.targetsQueued > 0;
                    updateSwarmStatus(isRunning ? 'running' : 'stopped', {
                        active: data.data.activeWorkers,
                        total: data.data.totalWorkers
                    }, data.data.targetsQueued);

                    // Update workers
                    updateWorkersList(data.data.workers);

                    // Update targets status if we have results
                    if (data.data.results) {
                        // Mark completed targets
                        data.data.results.completed.forEach(completed => {
                            const target = targets.find(t => t.url === completed.url);
                            if (target) {
                                target.status = 'completed';
                            }
                        });

                        // Mark failed targets
                        data.data.results.failed.forEach(failed => {
                            const target = targets.find(t => t.url === failed.url);
                            if (target) {
                                target.status = 'failed';
                            }
                        });

                        updateTargetsList();
                    }
                }
            } catch (error) {
                console.error('Failed to fetch swarm stats:', error);
                updateSwarmStatus('error', { active: 0, total: 0 }, 0);
            }
        }

        // Event listeners
        document.getElementById('add-target').addEventListener('click', () => {
            const newTarget = {
                id: nextTargetId++,
                url: `example${nextTargetId - 1}.com`,
                type: 'surface',
                priority: 1,
                status: 'pending'
            };
            targets.push(newTarget);
            updateTargetsList();
            addActivityLog(`Target added: ${newTarget.url}`, 'info');
        });

        document.getElementById('start-swarm').addEventListener('click', async () => {
            if (targets.length === 0) {
                addActivityLog('No targets configured', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targets })
                });

                const result = await response.json();
                if (result.success) {
                    addActivityLog(`Swarm started with ${result.targetsQueued} targets`, 'success');
                    updateSwarmStatus('starting', { active: 0, total: 0 }, targets.length);
                } else {
                    addActivityLog('Failed to start swarm', 'error');
                }
            } catch (error) {
                addActivityLog('Error starting swarm', 'error');
                console.error('Start swarm error:', error);
            }
        });

        document.getElementById('stop-swarm').addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_BASE}/stop`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                if (result.success) {
                    addActivityLog('Swarm stopped successfully', 'warning');
                    updateSwarmStatus('stopped', { active: 0, total: 0 }, 0);
                } else {
                    addActivityLog('Failed to stop swarm', 'error');
                }
            } catch (error) {
                addActivityLog('Error stopping swarm', 'error');
                console.error('Stop swarm error:', error);
            }
        });

        // Initialize
        addActivityLog('Swarm Control Panel initialized', 'info');
        updateTargetsList();

        // Start fetching stats
        fetchSwarmStats();

        // Update stats every 3 seconds
        setInterval(fetchSwarmStats, 3000);

        // Re-initialize Lucide icons periodically
        setInterval(() => {
            lucide.createIcons();
        }, 1000);
    </script>
</body>
</html>
